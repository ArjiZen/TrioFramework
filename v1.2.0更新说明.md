1. 更新DLL，版本1.2.0
2. FormController.View方法中增加engine.CanViewWorkflow()方法判断能否查看当前工单
3. 将WorkflowEngine.Instance修改为WorkflowEngine.Create()
4. 更新待办脚本
5. 更新已办脚本，更新已办视图脚本
6. 修改Part\ApproveHistory.cshtml的审批人显示字段
7. 修改待办已办，增加IsDelegate字段，标示是否为委托
8. 修改待办页面，标题列增加委托标识
9. 修改Part\Toolbar.cshtml，增加签收按钮及相关脚本
10. 在Controller中重写ResolveTobeReadActor方法设置待阅人员

**待办脚本**

```
SELECT  *FROM    ( SELECT    wi.AppCode ,                    wd.Name AS 'AppName' ,                    wii.InstanceNo ,                    wii.TaskId ,                    wi.Title ,                    wi.Creator ,                    wi.CreatorDeptName ,                    wii.ReceTime AS 'StartTime' ,                    wii.CurrentActi ,                    biz.RequirementNo ,                    biz.SourceText ,                    biz.TypeText ,                    biz.BigCategoryText ,                    biz.SmallCategoryText ,                    biz.IsJJXC ,                    ISNULL(biz.DeptSortNo, 0) AS 'DeptSortNo' ,                    ISNULL(biz.CompanySortNo, 0) AS 'CompanySortNo' ,                    biz.FileStatus ,                    0 as 'IsDelegate'          FROM      dbo.WF_WorkflowItem wii                    LEFT JOIN dbo.WF_WorkflowInstance wi ON wii.InstanceNo = wi.InstanceNo                    LEFT JOIN dbo.WF_Definition wd ON wi.AppCode = wd.AppCode                                                      AND wi.Version = wd.Version                    INNER JOIN dbo.Biz_MarketingSupport biz ON biz.InstanceNo = wi.InstanceNo          WHERE     PartId = #UserId#                    AND FinishTime IS NULL                    AND wi.Status IN ( 0, 1 )          UNION ALL          SELECT    wi.AppCode ,                    wd.Name AS 'AppName' ,                    wii.InstanceNo ,                    wii.TaskId ,                    wi.Title ,                    wi.Creator ,                    wi.CreatorDeptName ,                    wii.ReceTime AS 'StartTime' ,                    wii.CurrentActi ,                    biz.RequirementNo ,                    biz.SourceText ,                    biz.TypeText ,                    biz.BigCategoryText ,                    biz.SmallCategoryText ,                    biz.IsJJXC ,                    ISNULL(biz.DeptSortNo, 0) AS 'DeptSortNo' ,                    ISNULL(biz.CompanySortNo, 0) AS 'CompanySortNo' ,                    biz.FileStatus ,                    1 as 'IsDelegate'          FROM      dbo.WF_WorkflowItem wii                    LEFT JOIN dbo.WF_WorkflowInstance wi ON wii.InstanceNo = wi.InstanceNo                    LEFT JOIN dbo.WF_Definition wd ON wi.AppCode = wd.AppCode                                                      AND wi.Version = wd.Version                    INNER JOIN dbo.Biz_MarketingSupport biz ON biz.InstanceNo = wi.InstanceNo          WHERE     PartId IN (                    SELECT  DelegatorId                    FROM    dbo.WF_Delegates                    WHERE   MandataryId = #UserId#                            AND GETDATE() BETWEEN StartTime AND EndTime                            AND wii.ReceTime BETWEEN StartTime AND EndTime                            AND ISNULL(IsDeleted, 0) = 0 )                    AND FinishTime IS NULL                    AND wi.Status IN ( 0, 1 )        ) AS tbl    WHERE   1 = 1     {? AND Title like '%$Title$%' }    {? AND RequirementNo like '%$RequirementNo$%' }    {? AND StartTime >= #BeginDate# }    {? AND StartTime <= #EndDate# }    {? AND Source = #Source# }    {? AND Type = #Type# }    {? AND BigCategory = #BigCategory# }    {? AND SmallCategory = #SmallCategory# }
```

**已办脚本**

```
SELECT  ww.AppCode ,            wd.Name AS 'AppName' ,            b.InstanceNo ,            b.TaskId ,            ww.Title ,            ww.Creator ,            b.ReceTime AS 'StartTime' ,            b.CurrentActi ,            b.CurrentUsers ,            b.LastActi ,            biz.RequirementNo ,            biz.SourceText ,            biz.TypeText ,            biz.BigCategoryText ,            biz.SmallCategoryText ,            biz.IsJJXC ,            ISNULL(biz.DeptSortNo, 0) AS 'DeptSortNo' ,            ISNULL(biz.CompanySortNo, 0) AS 'CompanySortNo' ,            biz.FileStatus ,            CASE b.MandataryId WHEN NUll THEN 0 ELSE 1 END as 'IsDelegate'     FROM    dbo.WF_WorkflowInstance ww            INNER JOIN ( SELECT *                         FROM   View_WorkflowDoneInner wi                         WHERE  wi.TaskId >= 1                                AND ( wi.PartId = #UserId#                                      OR wi.MandataryId = #UserId#                                    )                       ) b ON ww.InstanceNo = b.InstanceNo                              AND rowId = 1            LEFT JOIN dbo.WF_Definition wd ON ww.AppCode = wd.AppCode                                              AND ww.Version = wd.Version            INNER JOIN dbo.Biz_MarketingSupport biz ON biz.InstanceNo = ww.InstanceNo    WHERE   1 = 1    {? AND biz.Title like '%$Title$%' }    {? AND biz.RequirementNo like '%$RequirementNo$%' }    {? AND ww.StartTime >= #BeginDate# }    {? AND ww.StartTime <= #EndDate# }    {? AND biz.Source = #Source# }    {? AND biz.Type = #Type# }    {? AND biz.BigCategory = #BigCategory# }    {? AND biz.SmallCategory = #SmallCategory# }
```

**已办视图脚本**

```
ALTER VIEW [dbo].[View_WorkflowDoneInner]AS    SELECT  *    FROM    ( SELECT    wi.InstanceNo ,                        wi.TaskId ,                        wi.PartDeptId ,                        wi.PartDeptName ,                        wi.PartId ,                        wi.PartName ,						wi.MandataryId,						wi.Mandatary,                        wi.CurrentActi AS LastActi ,                        wi.ReceTime ,                        wi.FinishTime ,                        wii.CurrentActi ,                        wii.CurrentUsers ,                        ROW_NUMBER() OVER ( PARTITION BY wi.InstanceNo, PartId ORDER BY FinishTime DESC ) AS rowId              FROM      dbo.WF_WorkflowItem wi                        LEFT JOIN ( SELECT  wi2.CurrentActi AS CurrentActi ,                                            wi2.InstanceNo ,                                            CurrentUsers = STUFF(( SELECT                                                              ','                                                              + ISNULL(t.PartName,                                                              '')                                                              FROM                                                              WF_WorkflowItem                                                              AS t                                                              WHERE                                                              t.InstanceNo = wi2.InstanceNo                                                              AND t.CurrentActi = wi2.currentActi                                                              AND t.FinishTime IS NULL                                                              FOR                                                              XML                                                              PATH('')                                                              ), 1, 1, '')                                    FROM    dbo.WF_WorkflowItem wi2                                    WHERE   EXISTS ( SELECT TOP 1                                                            1                                                     FROM   dbo.WF_WorkflowInstance wf                                                     WHERE  wi2.CurrentActi = wf.CurrentActivity                                                            AND wi2.InstanceNo = wf.InstanceNo                                                              AND wf.EndTime IS NULL                                                            )                                    GROUP BY wi2.InstanceNo ,                                            wi2.CurrentActi                                  ) wii ON wi.InstanceNo = wii.InstanceNo              WHERE     wi.TaskStatus >= 1--                        AND NOT EXISTS ( SELECT TOP 1 1--                                         FROM   dbo.WF_WorkflowInstance ww--                                         WHERE  ww.InstanceNo = wi.InstanceNo--                                                AND ww.CurrentActivity = wi.CurrentActi --                                                AND ww.--                                                )            ) c    WHERE   rowId = 1 GO
```


**审批人显示字段**

```
@(string.IsNullOrEmpty(item.Mandatary) ? "" : "(" + item.Mandatary + " 代办)")
```

**待办已办委托标识字段**

```
/// <summary>
/// 是否为委托数据
/// </summary>
public bool IsDelegate { get; set; }
```

**待办委托标示**

```
{{if $value.IsDelegate }}<button class="btn btn-mini btn-warning disabled">委托</button>{{/if}}
```


**ToolBar签收按钮***

```
if (!Model.CurrentActi.Equals("提出需求", StringComparison.OrdinalIgnoreCase) && !Model.Instance.CurrentWorkItem.SignTime.HasValue) {
    <a href="javascript:void(0);" id="toolbar_Sign"><img src="@Url.Content("~/Content/images/btn_idt_submit.gif")" />&nbsp;<span>签收</span></a>
}
```

**Toolbar签收脚本**

```
/*签收流程*/
$("#toolbar_Sign").click(function () {
    $.loading('show');
    var url = '@Url.Action("Sign", Model.Controller)';
    $.post(url, $("#frmWorkflow").serialize(), function (result) {
        $.loading('hide');
        if (result.success) {
            window.location.href = window.location.href;
        } else {
            $("#info").showError(result.errorMessage);
        }
    });
});
```